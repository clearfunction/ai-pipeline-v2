# Story Executor Lambda - Node.js Implementation

## Overview

This is the Node.js implementation of the Story Executor Lambda that uses Claude Code SDK directly for AI-driven code generation. It replaces the Python implementation and eliminates the need for template-based fallbacks.

## Features

- **Native Claude Code SDK Integration**: Uses Claude Code CLI directly without subprocess issues
- **Pure AI Generation**: No template fallbacks - all code generated by Claude
- **Step Functions Compatible**: Maintains same interface as Python Lambda
- **S3 Storage**: Stores generated code artifacts in S3
- **Multi-Story Support**: Processes multiple user stories in parallel

## Architecture

```
index.js                 - Lambda handler (Step Functions interface)
claude-code-generator.js - Claude Code SDK integration
s3-storage.js           - S3 artifact storage
package.json            - Dependencies
```

## Environment Variables

- `CODE_ARTIFACTS_BUCKET` - S3 bucket for code storage (default: ai-pipeline-v2-code-artifacts-{account}-{region})
- `USE_CLAUDE_AI` - Enable AI generation (default: true)
- `ANTHROPIC_API_KEY` - Retrieved from AWS Secrets Manager

## Lambda Configuration

- **Runtime**: Node.js 20.x
- **Handler**: index.handler
- **Memory**: 1024 MB
- **Timeout**: 15 minutes

## Input Format (from Step Functions)

```json
{
  "architecturePlannerResult": {
    "Payload": {
      "data": {
        "user_stories": [...],
        "architecture": {
          "project_id": "project-123",
          "name": "My Project",
          "tech_stack": "react_spa",
          "dependencies": {...},
          "build_config": {...}
        }
      }
    }
  }
}
```

## Output Format (to Step Functions)

```json
{
  "status": "success",
  "execution_id": "story_exec_...",
  "data": {
    "generated_files": [...],
    "files_stored_in_s3": {...},
    "processed_stories": [...],
    "architecture": {...}
  },
  "next_stage": "integration_validation"
}
```

## Development

### Local Testing

```bash
# Install dependencies
npm install

# Run local test
node test.js
```

### Deployment

```bash
# Deploy with CDK
cd infrastructure
npm run deploy-dev

# Or update code only
./scripts/deploy-single.sh story-executor-nodejs dev
```

## Migration from Python

This Lambda replaces the Python `story-executor` Lambda. Key differences:

1. **No Template Fallbacks**: Uses Claude Code SDK exclusively
2. **Native CLI Integration**: No subprocess/Python-to-Node issues
3. **Faster Cold Starts**: Node.js typically faster than Python
4. **Simpler Dependencies**: No mixed Python/Node layers

## Troubleshooting

### Claude Code CLI Not Found

The Lambda will attempt to install Claude Code CLI globally. If that fails, it uses `npx` to run it on-demand.

### S3 Access Issues

Ensure the Lambda execution role has permissions for:
- `s3:PutObject` on the artifacts bucket
- `s3:GetObject` for retrieval
- `s3:ListBucket` for listing files

### Memory/Timeout Issues

If generating large projects, you may need to increase:
- Memory to 2048 MB or 3008 MB
- Timeout to 15 minutes (maximum)

## Performance

- **Cold Start**: ~2-3 seconds (Node.js 20.x)
- **Code Generation**: 10-30 seconds per story (depends on complexity)
- **S3 Storage**: <1 second per file

## Future Improvements

- [ ] Add caching for repeated prompts
- [ ] Implement retry logic for Claude Code failures
- [ ] Add metrics for generation performance
- [ ] Support for incremental code updates
- [ ] Integration with code review workflows